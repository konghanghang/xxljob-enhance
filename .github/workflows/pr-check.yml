name: PR Check

on:
  pull_request:
    branches:
      - master

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test-backend:
    name: Test Backend
    uses: ./.github/workflows/test-reusable.yml
    with:
      service-name: backend
      working-directory: ./backend

  test-frontend:
    name: Test Frontend
    uses: ./.github/workflows/test-reusable.yml
    with:
      service-name: frontend
      working-directory: ./frontend

  build-backend-validation:
    name: Validate Backend Build
    runs-on: ubuntu-latest
    needs: test-backend
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Backend Docker image (validation only)
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          platforms: linux/amd64
          push: false
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:pr-${{ github.event.pull_request.number }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:buildcache
          load: true

      - name: Save Backend image for scanning
        run: |
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:pr-${{ github.event.pull_request.number }} -o backend-image.tar

      - name: Upload Backend image artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-image
          path: backend-image.tar
          retention-days: 1

  build-frontend-validation:
    name: Validate Frontend Build
    runs-on: ubuntu-latest
    needs: test-frontend
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend Docker image (validation only)
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          platforms: linux/amd64
          push: false
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:pr-${{ github.event.pull_request.number }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:buildcache
          load: true

      - name: Save Frontend image for scanning
        run: |
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:pr-${{ github.event.pull_request.number }} -o frontend-image.tar

      - name: Upload Frontend image artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-image
          path: frontend-image.tar
          retention-days: 1

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [build-backend-validation, build-frontend-validation]
    permissions:
      security-events: write

    steps:
      - name: Download Backend image
        uses: actions/download-artifact@v4
        with:
          name: backend-image

      - name: Load Backend image
        run: docker load -i backend-image.tar

      - name: Run Trivy scanner on Backend image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:pr-${{ github.event.pull_request.number }}
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Backend scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-backend-results.sarif'
          category: 'backend-image-pr'

      - name: Download Frontend image
        uses: actions/download-artifact@v4
        with:
          name: frontend-image

      - name: Load Frontend image
        run: docker load -i frontend-image.tar

      - name: Run Trivy scanner on Frontend image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:pr-${{ github.event.pull_request.number }}
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Frontend scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-frontend-results.sarif'
          category: 'frontend-image-pr'
