name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate-tag:
    name: Validate Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.parse.outputs.version }}
      major: ${{ steps.parse.outputs.major }}
      minor: ${{ steps.parse.outputs.minor }}
      patch: ${{ steps.parse.outputs.patch }}

    steps:
      - name: Parse version from tag
        id: parse
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}

          # Validate semantic versioning format (v1.2.3)
          if [[ ! $TAG_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Tag must follow semantic versioning format (v1.2.3)"
            exit 1
          fi

          # Extract version without 'v' prefix
          VERSION=${TAG_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Extract major, minor, patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT

          echo "Validated tag: $TAG_NAME"
          echo "Version: $VERSION (Major: $MAJOR, Minor: $MINOR, Patch: $PATCH)"

  test-backend:
    name: Test Backend
    needs: validate-tag
    uses: ./.github/workflows/test-reusable.yml
    with:
      service-name: backend
      working-directory: ./backend

  test-frontend:
    name: Test Frontend
    needs: validate-tag
    uses: ./.github/workflows/test-reusable.yml
    with:
      service-name: frontend
      working-directory: ./frontend

  build-backend:
    name: Build Backend Release
    runs-on: ubuntu-latest
    needs: [validate-tag, test-backend]
    timeout-minutes: 15
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
          tags: |
            type=raw,value=${{ needs.validate-tag.outputs.version }}
            type=raw,value=${{ needs.validate-tag.outputs.major }}.${{ needs.validate-tag.outputs.minor }}
            type=raw,value=${{ needs.validate-tag.outputs.major }}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:buildcache,mode=max

  build-frontend:
    name: Build Frontend Release
    runs-on: ubuntu-latest
    needs: [validate-tag, test-frontend]
    timeout-minutes: 10
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
          tags: |
            type=raw,value=${{ needs.validate-tag.outputs.version }}
            type=raw,value=${{ needs.validate-tag.outputs.major }}.${{ needs.validate-tag.outputs.minor }}
            type=raw,value=${{ needs.validate-tag.outputs.major }}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:buildcache,mode=max

  security-scan:
    name: Security Scan (Strict)
    runs-on: ubuntu-latest
    needs: [validate-tag, build-backend, build-frontend]
    permissions:
      security-events: write

    steps:
      - name: Run Trivy scanner on Backend image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ needs.validate-tag.outputs.version }}
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Backend scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-backend-results.sarif'
          category: 'backend-image-release'

      - name: Run Trivy scanner on Frontend image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ needs.validate-tag.outputs.version }}
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Frontend scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-frontend-results.sarif'
          category: 'frontend-image-release'

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-tag, security-scan]
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: notes
        run: |
          # Get previous tag
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "notes=Initial release" >> $GITHUB_OUTPUT
          else
            # Generate changelog from commits
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.validate-tag.outputs.version }}
          release_name: Release v${{ needs.validate-tag.outputs.version }}
          body: |
            ## ðŸš€ Release v${{ needs.validate-tag.outputs.version }}

            ### Docker Images

            **Backend:**
            - `ghcr.io/${{ github.repository }}-backend:${{ needs.validate-tag.outputs.version }}`
            - `ghcr.io/${{ github.repository }}-backend:${{ needs.validate-tag.outputs.major }}.${{ needs.validate-tag.outputs.minor }}`
            - `ghcr.io/${{ github.repository }}-backend:${{ needs.validate-tag.outputs.major }}`
            - `ghcr.io/${{ github.repository }}-backend:latest`

            **Frontend:**
            - `ghcr.io/${{ github.repository }}-frontend:${{ needs.validate-tag.outputs.version }}`
            - `ghcr.io/${{ github.repository }}-frontend:${{ needs.validate-tag.outputs.major }}.${{ needs.validate-tag.outputs.minor }}`
            - `ghcr.io/${{ github.repository }}-frontend:${{ needs.validate-tag.outputs.major }}`
            - `ghcr.io/${{ github.repository }}-frontend:latest`

            ### Changes

            ${{ steps.notes.outputs.notes }}

            ### Security

            âœ… All images have been scanned with Trivy and passed security checks.
          draft: false
          prerelease: false
